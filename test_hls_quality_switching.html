<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HLS Quality Switching Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        .lecture-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .lecture-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e9ecef;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        .lecture-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #495057;
        }
        .video-container {
            margin: 15px 0;
        }
        video {
            width: 100%;
            max-height: 250px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .quality-info {
            background: #e8f4fd;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 14px;
        }
        .quality-badge {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin: 2px;
        }
        .url-display {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            margin: 8px 0;
            border: 1px solid #dee2e6;
        }
        .controls {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            transition: transform 0.2s;
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .btn.secondary {
            background: #6c757d;
        }
        .status {
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            display: inline-block;
            margin: 5px 0;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .quality-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        .quality-btn {
            background: #e9ecef;
            color: #495057;
            border: 1px solid #dee2e6;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .quality-btn:hover {
            background: #667eea;
            color: white;
        }
        .quality-btn.active {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }
        .info-section {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #ffc107;
        }
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .feature-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        .feature-card h4 {
            margin: 0 0 8px 0;
            color: #495057;
            font-size: 16px;
        }
        .feature-card p {
            margin: 0;
            font-size: 14px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé¨ HLS Quality Switching Demo</h1>

        <div class="info-section">
            <h3>üéØ How Quality Switching Works:</h3>
            <ol>
                <li>Load the <strong>Master HLS Playlist</strong> (contains all quality options)</li>
                <li>HLS player automatically selects best quality based on internet speed</li>
                <li>Quality switches seamlessly during playback</li>
                <li>User can manually force quality changes</li>
            </ol>
        </div>

        <div class="feature-grid">
            <div class="feature-card">
                <h4>üé® Multiple Qualities</h4>
                <p>360p, 480p, 720p, 1080p</p>
            </div>
            <div class="feature-card">
                <h4>‚ö° Adaptive Streaming</h4>
                <p>Auto quality adjustment</p>
            </div>
            <div class="feature-card">
                <h4>üì± Device Optimized</h4>
                <p>Mobile, tablet, desktop</p>
            </div>
            <div class="feature-card">
                <h4>üåê Bandwidth Efficient</h4>
                <p>Only downloads needed quality</p>
            </div>
        </div>

        <div class="lecture-grid">
            <!-- Lecture 2 -->
            <div class="lecture-card">
                <div class="lecture-title">üìπ Lecture: "wowed" (ID: 2)</div>

                <div class="quality-info">
                    <strong>Available Qualities:</strong>
                    <span class="quality-badge">360p</span>
                    <span class="quality-badge">480p</span>
                    <span class="quality-badge">720p</span>
                    <span class="quality-badge">1080p</span>
                </div>

                <div class="url-display">
                    <strong>Master HLS URL:</strong><br>
                    http://127.0.0.1:8002/media/lecture_videos/hls/lecture_2_master.m3u8
                </div>

                <div class="video-container">
                    <video id="video2" controls poster="">
                        Your browser does not support HLS video playback.
                    </video>
                </div>

                <div class="controls">
                    <div class="quality-selector">
                        <button class="quality-btn active" onclick="loadLecture(2, 'auto')">Auto Quality</button>
                        <button class="quality-btn" onclick="loadLecture(2, '1080p')">Force 1080p</button>
                        <button class="quality-btn" onclick="loadLecture(2, '720p')">Force 720p</button>
                        <button class="quality-btn" onclick="loadLecture(2, '480p')">Force 480p</button>
                        <button class="quality-btn" onclick="loadLecture(2, '360p')">Force 360p</button>
                    </div>

                    <div id="status2" class="status info">
                        Click "Auto Quality" to start playback
                    </div>
                </div>
            </div>

            <!-- Lecture 3 -->
            <div class="lecture-card">
                <div class="lecture-title">üìπ Lecture: "pdf" (ID: 3)</div>

                <div class="quality-info">
                    <strong>Available Qualities:</strong>
                    <span class="quality-badge">360p</span>
                    <span class="quality-badge">480p</span>
                    <span class="quality-badge">720p</span>
                    <span class="quality-badge">1080p</span>
                </div>

                <div class="url-display">
                    <strong>Master HLS URL:</strong><br>
                    http://127.0.0.1:8002/media/lecture_videos/hls/lecture_3_master.m3u8
                </div>

                <div class="video-container">
                    <video id="video3" controls poster="">
                        Your browser does not support HLS video playback.
                    </video>
                </div>

                <div class="controls">
                    <div class="quality-selector">
                        <button class="quality-btn active" onclick="loadLecture(3, 'auto')">Auto Quality</button>
                        <button class="quality-btn" onclick="loadLecture(3, '1080p')">Force 1080p</button>
                        <button class="quality-btn" onclick="loadLecture(3, '720p')">Force 720p</button>
                        <button class="quality-btn" onclick="loadLecture(3, '480p')">Force 480p</button>
                        <button class="quality-btn" onclick="loadLecture(3, '360p')">Force 360p</button>
                    </div>

                    <div id="status3" class="status info">
                        Click "Auto Quality" to start playback
                    </div>
                </div>
            </div>
        </div>

        <div class="info-section">
            <h3>üìã Testing Instructions:</h3>
            <ol>
                <li>Click <strong>"Auto Quality"</strong> on any lecture to start playback</li>
                <li>Watch the video play with automatic quality switching</li>
                <li>Try <strong>"Force Quality"</strong> buttons to manually change quality</li>
                <li>Monitor the status messages for quality changes</li>
                <li>Open browser dev tools ‚Üí Network tab to see quality switching</li>
            </ol>

            <h3>üîß Manual Quality URLs:</h3>
            <ul>
                <li><strong>Lecture 2 1080p:</strong> <code>http://127.0.0.1:8002/media/lecture_videos/hls/lecture_2_1080p/lecture_2_1080p.m3u8</code></li>
                <li><strong>Lecture 2 720p:</strong> <code>http://127.0.0.1:8002/media/lecture_videos/hls/lecture_2_720p/lecture_2_720p.m3u8</code></li>
                <li><strong>Lecture 3 480p:</strong> <code>http://127.0.0.1:8002/media/lecture_videos/hls/lecture_3_480p/lecture_3_480p.m3u8</code></li>
            </ul>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script>
        // HLS player instances
        let hls2 = null;
        let hls3 = null;

        function updateStatus(lectureId, message, isError = false) {
            const statusDiv = document.getElementById(`status${lectureId}`);
            statusDiv.textContent = message;
            statusDiv.className = `status ${isError ? 'error' : 'success'}`;
        }

        function loadLecture(lectureId, quality) {
            const video = document.getElementById(`video${lectureId}`);
            const statusDiv = document.getElementById(`status${lectureId}`);

            // Update button states
            const buttons = statusDiv.parentElement.querySelectorAll('.quality-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Destroy existing HLS instance
            if (lectureId === 2 && hls2) {
                hls2.destroy();
            } else if (lectureId === 3 && hls3) {
                hls3.destroy();
            }

            // Determine HLS URL
            let hlsUrl;
            if (quality === 'auto') {
                hlsUrl = `http://127.0.0.1:8002/media/lecture_videos/hls/lecture_${lectureId}_master.m3u8`;
            } else {
                hlsUrl = `http://127.0.0.1:8002/media/lecture_videos/hls/lecture_${lectureId}_${quality}/lecture_${lectureId}_${quality}.m3u8`;
            }

            updateStatus(lectureId, `Loading ${quality === 'auto' ? 'master playlist' : quality + ' quality'}...`);

            if (Hls.isSupported()) {
                const hls = new Hls({
                    debug: false, // Set to true for detailed logs
                    enableWorker: true,
                    lowLatencyMode: true,
                    backBufferLength: 90
                });

                if (lectureId === 2) {
                    hls2 = hls;
                } else {
                    hls3 = hls;
                }

                hls.loadSource(hlsUrl);
                hls.attachMedia(video);

                hls.on(Hls.Events.MANIFEST_PARSED, function(event, data) {
                    updateStatus(lectureId, `‚úÖ Loaded! ${data.levels.length} quality level(s) available`);
                    console.log(`Lecture ${lectureId} manifest parsed:`, data);
                });

                hls.on(Hls.Events.LEVEL_SWITCHED, function(event, data) {
                    const qualityNames = ['360p', '480p', '720p', '1080p'];
                    const qualityName = qualityNames[data.level] || `Level ${data.level}`;
                    updateStatus(lectureId, `üîÑ Switched to ${qualityName} quality`);
                    console.log(`Quality switched to level ${data.level} (${qualityName})`);
                });

                hls.on(Hls.Events.ERROR, function(event, data) {
                    console.error('HLS Error:', data);
                    updateStatus(lectureId, `‚ùå HLS Error: ${data.details}`, true);
                });

            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // Native HLS support (Safari)
                video.src = hlsUrl;
                updateStatus(lectureId, `‚úÖ Loaded (Native HLS support)`);
            } else {
                updateStatus(lectureId, '‚ùå HLS is not supported in this browser', true);
            }
        }

        // Initialize videos
        document.addEventListener('DOMContentLoaded', function() {
            console.log('HLS Quality Switching Demo loaded');
            console.log('HLS.js supported:', Hls.isSupported());
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (hls2) hls2.destroy();
            if (hls3) hls3.destroy();
        });
    </script>
</body>
</html>
